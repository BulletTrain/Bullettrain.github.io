title: 群晖ds218+旁路由实战

date: 2019-09-07 22:50:40

categories: 个人

tags: [群晖,旁路由,LEDE]

------

>迫于家里的华硕路由刷了梅林后，导致cpu经常爆90%到100%,经常性温度特别高，不得不隔断时间就要重启,非常影响体验，一气之下又刷回了官方固件，各种稳定，爽歪歪，代价也就没有了梅林的各种插件，少了不少便利。

一直在网上找寻各种方案，得出以下三个方案
- 方案一 换路由，上ac86u，配置足够满足需求，好心水，就是价格太贵网上反映好像还有断流现象
- 方案二 上软路由，ROS+LEDE方案，优点是软路由稳定性配置还有定制性秒杀硬路由，缺点就是贵，发热也是问题，弱电箱能否放下也是问题
- 方案三 旁路由解决方案，市面上常用的香橙派等体积小巧配置够用，发热功耗也还好，缺点就是不知道质量能否保证长期稳定运行

思索再三，方案一迫于价格太贵，一直下不了手，方案二也是考虑价格以及后续问题没下手，就剩下方案三的方案了，香橙派倒是不贵，体积也小，但是弱电箱好像插座不够了，两个已插满，很是纠结。。。。

这时候，坐上我的人体工程学椅子，45度仰天思考，群晖的三个小灯亮瞎我的24k金狗眼，对，群晖不是有vmm可以装lede，能否考虑下做个旁路由，满足家里需求，所以开干



### 第一步 下载镜像

前往 [Koolshare LEDE x64 固件下载页](https://firmware.koolshare.cn/LEDE_X64_fw867/%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BD%AC%E7%9B%98%E6%88%96PE%E4%B8%8B%E5%86%99%E7%9B%98%E4%B8%93%E7%94%A8/) 中下载文件名包含 combined-squashfs 的固件，解压 gz 得到 img 文件。



### 第二步 配置vmm

群晖提供了一个虚拟机服务 Virtual Machine Manager（简称 VMM），系统中默认没有安装，需要去套件中心下载安装并启用。
![QQ20190908-002002](https://www.flyada.com/images/QQ20190908-002002.png)

在群晖的管理界面中打开 VMM，点击左侧「存储」进入存储管理。点击「新增」，选择用于安装和存储虚拟机的硬盘。


创建好存储以后在「VMM - 映像 - 新增」中上传之前解压出来的 img 文件。设置名称、选择从计算机上传。![QQ20190908-002047](https://www.flyada.com/images/QQ20190908-002047.png)

 上传成功以后可以看到上传的映像出现在列表中。

在「VMM - 网络」中设置虚拟交换机。迫于我的ds218+只有一个千兆网口，所以 Default VM Network 默认就已经绑定在唯一的网口下面了。点击 Default VM Network，删除。然后点击「新增」开始创建新的虚拟交换机。![QQ20190908-002924](https://www.flyada.com/images/QQ20190908-002924.png)

现在 VMM 已经基本已经配置完毕，可以创建虚拟机了。



### 第三步 新建虚拟机

在「VMM - 虚拟机」中，在「新增」按钮边上的下拉菜单（那个三角尖）中选择「导入」，在导入方式中选择「从硬盘映像导入」，并找到刚才上传的映像。![QQ20190908-002310](https://www.flyada.com/images/QQ20190908-002310.png)

选择存储空间配置虚拟机规格，推荐 双核 + 2G 内存（迫于我的加了4g内存，现在6g内存绰绰有余），显卡就用默认配置就行了。![QQ20190908-002211](https://www.flyada.com/images/QQ20190908-002211.png)

下一步是存储空间相关设置。通过硬盘映像导入的虚拟机强制使用 10G 硬盘，实际上是动态占用的，不用担心。
![QQ20190908-002328](https://www.flyada.com/images/QQ20190908-002328.png)


网络，我之前只创建了一个虚拟交换机，所以这里已经添加好了唯一的虚拟交换机。如果你是多网口 NAS 做软路由、那么还要通过「+」添加之前创建的多个虚拟交换机。

都确认完毕后，这个时候先不要选择自动启动，等后面配置完了再修改，这步**很重要**![QQ20190908-002448](https://www.flyada.com/images/QQ20190908-002448.png)



### 第四步 配置网络

在「VMM - 虚拟机」中找到 Koolshare lede，点击「连接」进入。开机之后内核日志不再滚动（出现 br-lan: link is ready）以后按下回车，进入命令行。

使用 vim /etc/config/network 进入接口编辑，修改 LAN 口配置。比如我的群晖接在我的主路由下面，网段是 192.168.1.1，我的 NAS 分配了 192.168.1.120，于是我给 Koolshare LEDE 分配了 192.168.1.200，子网掩码保持 255.255.255.0 不变，网卡是 NAS 唯一的网口 eth0 保持不变）。

修改完以后使用 /etc/init.d/network restart 重启网卡以生效配置。当然你也可以用 reboot 达到相同的效果。



### 第五步 配置LEDE

如果上面配置顺利，这时候直接在网站输入192.168.1.200就能进入LEDE管理界面
![QQ20190908-004118](https://www.flyada.com/images/QQ20190908-004118.png)

默认的密码是koolshare,登录进入可以修改密码
![QQ20190908-004219](https://www.flyada.com/images/QQ20190908-004219.png)

第一次网口状态并不是全双工，显示半双工
需要关闭LEDE，在网络设置里选择1000那个选项，在重启下LEDE，就可以看到全双工了



这时候可以在酷软商店下载各种插件使用了
![QQ20190908-004312](https://www.flyada.com/images/QQ20190908-004312.png)



> 2019年9月8日添加

因为是旁路由，删除相关wan口

![WX20190908-131303](https://www.flyada.com/images/WX20190908-131303.png)

lan口配置如下

![WX20190908-131341](https://www.flyada.com/images/WX20190908-131426.png)



为了确保旁路由的ip不变，主路由给dhcp固定下旁路由的mac绑定的ip不变



到达此部，旁路由配置基本就结束了

此时在主路由上网关改成192.168.1.200，就能全网使用旁路由的LEDE插件了，此时可以自行摸索了

哈哈😄，终于可以放心稳定了解决了家里网络的所有稳定。
